<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Laporan Penilaian Sensori - Organoleptik Ikan</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
<style>
:root{--max-w:900px;font-family:'Times New Roman',Times,serif}
body{background:#f3f3f3;color:#111;padding:24px;display:flex;justify-content:center}
.container{width:100%;max-width:var(--max-w);background:white;padding:22px;border:1px solid #ddd}
h1{font-size:18px;margin:0 0 6px;text-align:center}

/* === KOP SURAT === */
.kop, .report-kop {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  padding-bottom: 4px;
  margin-bottom: 8px;
}

.kop .logo, .report-logo {
  position: absolute;
  left: 0;
  top: 0;
  width: 90px;
  height: 90px;
}

.kop .logo img, .report-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.kop-center, .report-center {
  text-align: center;
  width: 100%;
  font-family: 'Times New Roman', Times, serif;
  line-height: 1.2;
  padding-left: 40px; /* jarak teks dari logo kiri */
}

.kop-center .instansi,
.report-center .instansi {
  font-size: 16px;
  font-weight: bold;
  text-transform: uppercase;
}

.kop-center .sub, .report-center .sub {
  font-size: 12px;
}

.kop-center .small, .report-center .alamat, .report-center .kontak {
  font-size: 10px;
}

hr, .report-line {
  border: 2px solid #000;
  margin-top: 10px;
  margin-bottom: 16px;
  margin-left: 100px; /* ruang agar garis tidak menabrak logo */
}

/* === FORM === */
.form-section{margin-top:8px}
label{display:block;font-weight:600;margin-top:8px}
select, input, textarea, button{font-family:inherit}
input[type=text], input[type=date], select, textarea{width:100%;padding:6px;border:1px solid #bbb;border-radius:2px}
.row{display:flex;gap:12px}
.col{flex:1}
table{width:100%;border-collapse:collapse;margin-top:10px}
table, th, td{border:1px solid #333}
th, td{padding:6px;font-size:13px}
th{text-align:left;background:#efefef}
.small{font-size:12px;color:#444}
.actions{display:flex;gap:10px;margin-top:12px}
button{padding:8px 12px;border:0;background:#222;color:white;border-radius:4px;cursor:pointer}
button.secondary{background:#666}

/* === LAPORAN (PDF) === */
#report{width:800px;padding:24px;background:white;color:#000;margin:12px auto;border:1px solid #999;display:none}
#report h2{text-align:center;margin:8px 0}
#report table{width:100%;border-collapse:collapse;margin-top:10px}
#report th, #report td{border:1px solid #000;padding:6px;font-size:12px;vertical-align:middle;text-align:center}
#report td:first-child{text-align:left}
.sign{width:120px;height:auto;margin-bottom:4px}

/* === AREA TANDA TANGAN === */
#signature-container {
  display: flex;
  justify-content: flex-end;
  align-items: flex-end;
  height: 90px;
}
#signature-container img {
  max-height: 70px;
  object-fit: contain;
}
#name-panelis {
  margin-top: 8px;
  display: inline-block;
  font-style: italic;
}

/* === MODAL PDF PREVIEW === */
#modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center}
#modal .box{width:90%;height:90%;background:#fff;padding:10px;display:flex;flex-direction:column}
#modal iframe{flex:1;border:1px solid #ccc}
#modal .foot{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}

.spec-controls{display:flex;gap:8px;align-items:center;margin-top:6px}
.spec-list{font-size:13px;color:#333;margin-left:8px}
@media(max-width:800px){:root{--max-w:700px}.row{flex-direction:column}}
</style>
</head>
<body>
<div class="container">
  <div class="kop">
    <div class="logo">
      <img src="signatures/barantSan.png" alt="Logo Instansi">
    </div>
    <div class="kop-center">
      <div class="instansi">BADAN KARANTINA INDONESIA</div>
      <div class="sub small">LABORATORIUM KARANTINA HEWAN, IKAN, DAN TUMBUHAN KALIMANTAN UTARA</div>
      <div class="small">Jl. Yos Sudarso No.11 RT.04, Kel. Lingkas Ujung, Kec. Tarakan Timur, Kota Tarakan - Kalimantan Utara 77126</div>
      <div class="small">TELEPON (0551) 21526 , 08115442414  FAKSIMILE (0551) 36508</div>
    </div>
  </div>

  <hr>

  <h1>Lembar Penilaian Sensori - Ikan Segar</h1>

  <div class="form-section">
    <div class="row">
      <div class="col">
        <label>Nama Panelis</label>
        <select id="panelis">
          <option value="">-- Pilih Nama Panelis --</option>
          <option value="Ayu An Nisaa">Ayu An Nisaa</option>
          <option value="Nurwati">Nurwati</option>
          <option value="Etik Marlena">Etik Marlena</option>
          <option value="Anevy Zainul Isa">Anevy Zainul Isa</option>
        </select>
      </div>
      <div class="col">
        <label>Tanggal</label>
        <input type="date" id="tanggal">
      </div>
    </div>

    <label>Komoditas</label>
    <input type="text" id="kode" placeholder="Masukkan kode contoh...">

    <label class="small">Petunjuk: Untuk setiap subspesifikasi klik dropdown pilih nilai lalu tekan "Tambah Penilaian". Maksimum 5 penilaian per subspesifikasi.</label>

    <div id="spesifikasi-area">
      <h3>1. Kenampakan</h3>
      <h4>a. Mata</h4>
      <div class="spec-controls">
        <select id="mataOption">
          <option value="">-- Pilih Kondisi Mata --</option>
          <option value="9">9 - Bola mata cembung, kornea dan pupil jernih, mengkilap.</option>
          <option value="7">7 - Bola mata agak rata, sedikit keruh.</option>
          <option value="5">5 - Bola mata cekung, keruh.</option>
        </select>
        <button type="button" onclick="tambahPenilaian('mata')">Tambah Penilaian</button>
        <div class="spec-list"><strong>Nilai:</strong> <span id="mata-list">-</span> &nbsp; <strong>Rerata:</strong> <span id="mata-avg">-</span></div>
      </div>

      <h4>b. Insang</h4>
      <div class="spec-controls">
        <select id="insangOption">
          <option value="">-- Pilih Kondisi Insang --</option>
          <option value="9">9 - Merah darah, sedikit lendir transparan.</option>
          <option value="7">7 - Merah tua, sedikit lendir keruh.</option>
          <option value="5">5 - Coklat abu-abu, lendir tebal.</option>
        </select>
        <button type="button" onclick="tambahPenilaian('insang')">Tambah Penilaian</button>
        <div class="spec-list"><strong>Nilai:</strong> <span id="insang-list">-</span> &nbsp; <strong>Rerata:</strong> <span id="insang-avg">-</span></div>
      </div>

      <h4>c. Lendir Permukaan Badan</h4>
      <div class="spec-controls">
        <select id="lendirOption">
          <option value="">-- Pilih Kondisi Lendir --</option>
          <option value="9">9 - Lendir jernih, mengkilap.</option>
          <option value="7">7 - Lendir agak keruh.</option>
          <option value="5">5 - Lendir tebal & berubah warna.</option>
        </select>
        <button type="button" onclick="tambahPenilaian('lendir')">Tambah Penilaian</button>
        <div class="spec-list"><strong>Nilai:</strong> <span id="lendir-list">-</span> &nbsp; <strong>Rerata:</strong> <span id="lendir-avg">-</span></div>
      </div>

      <h3>2. Daging</h3>
      <div class="spec-controls">
        <select id="dagingOption">
          <option value="">-- Pilih Kondisi Daging --</option>
          <option value="9">9 - Sayatan daging sangat cemerlang.</option>
          <option value="7">7 - Sayatan sedikit kurang cemerlang.</option>
          <option value="5">5 - Sayatan mulai pudar.</option>
        </select>
        <button type="button" onclick="tambahPenilaian('daging')">Tambah Penilaian</button>
        <div class="spec-list"><strong>Nilai:</strong> <span id="daging-list">-</span> &nbsp; <strong>Rerata:</strong> <span id="daging-avg">-</span></div>
      </div>

      <h3>3. Bau</h3>
      <div class="spec-controls">
        <select id="bauOption">
          <option value="">-- Pilih Kondisi Bau --</option>
          <option value="9">9 - Sangat segar.</option>
          <option value="7">7 - Segar.</option>
          <option value="5">5 - Netral/asam.</option>
        </select>
        <button type="button" onclick="tambahPenilaian('bau')">Tambah Penilaian</button>
        <div class="spec-list"><strong>Nilai:</strong> <span id="bau-list">-</span> &nbsp; <strong>Rerata:</strong> <span id="bau-avg">-</span></div>
      </div>

      <h3>4. Tekstur</h3>
      <div class="spec-controls">
        <select id="TeksturOption">
          <option value="">-- Pilih Kondisi Tekstur --</option>
          <option value="9">9 - Padat, kompak.</option>
          <option value="7">7 - Padat, kurang kompak.</option>
          <option value="5">5 - Kurang padat.</option>
        </select>
        <button type="button" onclick="tambahPenilaian('Tekstur')">Tambah Penilaian</button>
        <div class="spec-list"><strong>Nilai:</strong> <span id="Tekstur-list">-</span> &nbsp; <strong>Rerata:</strong> <span id="Tekstur-avg">-</span></div>
      </div>
    </div>

    <label>Keterangan tambahan</label>
    <textarea id="keterangan" rows="3" placeholder="Catatan lain..."></textarea>

    <div class="actions">
      <button id="previewBtn">Preview PDF</button>
      <button id="downloadBtn" class="secondary">Download PDF</button>
    </div>
  </div>
</div>

<!-- REPORT PDF -->
<div id="report">
  <div class="report-kop">
    <div class="report-logo">
      <img src="signatures/barantSan.png" alt="Logo Instansi">
    </div>
    <div class="report-center">
      <div class="instansi">BADAN KARANTINA INDONESIA</div>
      <div class="sub">LABORATORIUM KARANTINA HEWAN, IKAN, DAN TUMBUHAN KALIMANTAN UTARA</div>
      <div class="alamat">Jl. Yos Sudarso No.11 RT.04, Kel. Lingkas Ujung, Kec. Tarakan Timur, Kota Tarakan - Kalimantan Utara 77126</div>
      <div class="kontak">TELEPON (0551) 21526 , 08115442414  FAKSIMILE (0551) 36508</div>
    </div>
  </div>
  <hr class="report-line">

  <h2>Lembar Penilaian Sensori Ikan Segar</h2>
  <div style="display:flex;justify-content:space-between;gap:10px;margin-top:6px">
    <div><strong>Nama panelis:</strong> <span id="r-panelis"></span><br><strong>Tanggal:</strong> <span id="r-tanggal"></span></div>
    <div><strong>Komoditas:</strong> <span id="r-kode"></span></div>
  </div>

  <table style="margin-top:10px;text-align:center"><tbody id="r-body"></tbody></table>

  <div style="margin-top:14px"><strong>Keterangan:</strong> <div id="r-keterangan" style="white-space:pre-wrap;margin-top:6px"></div></div>
  <div style="margin-top:10px"><strong>Kesimpulan:</strong> <div id="r-kesimpulan" style="white-space:pre-wrap;margin-top:6px"></div></div>

  <div style="text-align:right;margin-top:28px;">
    <div>Panelis,</div>
    <div style="height:60px" id="signature-container"></div>
    <div id="name-panelis" style="font-style:italic"></div>
  </div>
</div>

<!-- MODAL PDF -->
<div id="modal">
  <div class="box">
    <iframe id="pdfFrame"></iframe>
    <div class="foot">
      <button id="modalClose" class="secondary">Tutup</button>
      <a id="modalDownload" href="#" download="laporan-organoleptik.pdf"><button>Download PDF</button></a>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const nilaiStore = { mata: [], insang: [], lendir: [], daging: [], bau: [], Tekstur: [] };

function updateDisplay(k) {
  const l = document.getElementById(`${k}-list`);
  const a = document.getElementById(`${k}-avg`);
  const r = nilaiStore[k];
  l.innerText = r.length ? r.join(', ') : '-';
  a.innerText = r.length ? (r.reduce((a, b) => a + b, 0) / r.length).toFixed(2) : '-';
}

function tambahPenilaian(k) {
  const s = document.getElementById(k + 'Option');
  const v = parseInt(s.value);
  if (!v) { alert('Pilih nilai dahulu!'); return }
  if (nilaiStore[k].length >= 5) { alert('Maks 5 nilai.'); s.value = ''; return }
  nilaiStore[k].push(v); s.value = ''; updateDisplay(k);
}

document.getElementById('panelis').addEventListener('change', async () => {
  const panelis = document.getElementById('panelis').value;
  const name = document.getElementById('name-panelis');
  const sig = document.getElementById('signature-container');
  name.innerText = panelis ? `(${panelis})` : '';
  sig.innerHTML = '';

  if (panelis) {
    const img = new Image();
    img.src = `signatures/${panelis}.png`;
    img.className = 'sign';
    img.crossOrigin = 'anonymous';
    await new Promise((resolve, reject) => {
      img.onload = resolve; img.onerror = reject;
    });
    sig.appendChild(img);
  }
});

function collectData() {
  return {
    panelis: document.getElementById('panelis').value || '-',
    tanggal: document.getElementById('tanggal').value || '-',
    kode: document.getElementById('kode').value || '-',
    keterangan: document.getElementById('keterangan').value || '-',
    nilai: {...nilaiStore}
  };
}

function populateReport(data) {
  document.getElementById('r-panelis').innerText = data.panelis;
  document.getElementById('r-tanggal').innerText = data.tanggal;
  document.getElementById('r-kode').innerText = data.kode;
  document.getElementById('r-keterangan').innerText = data.keterangan;

  const tb = document.getElementById('r-body');
  tb.innerHTML = '';
  for (const [key, arr] of Object.entries(data.nilai)) {
    const avg = arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2) : '-';
    tb.innerHTML += `<tr><td>${key}</td><td>${arr.join(', ') || '-'}</td><td>${avg}</td></tr>`;
  }
}

async function renderReportToPdf(openInNewTab=true) {
  const data = collectData();
  populateReport(data);
  const el = document.getElementById('report');
  el.style.display = 'block';
  const canvas = await html2canvas(el, { scale:3, useCORS:true });
  const img = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({orientation:'p',unit:'pt',format:'a4'});
  const w = pdf.internal.pageSize.getWidth();
  const h = pdf.internal.pageSize.getHeight();
  const imgH = canvas.height * (w / canvas.width);
  pdf.addImage(img, 'PNG', 0, 0, w, imgH);
  const blob = pdf.output('bloburl');
  if (openInNewTab) window.open(blob);
  else {
    document.getElementById('modal').style.display='flex';
    document.getElementById('pdfFrame').src=blob;
    document.getElementById('modalDownload').href=blob;
  }
  el.style.display='none';
}

document.getElementById('previewBtn').onclick = ()=>renderReportToPdf(false);
document.getElementById('downloadBtn').onclick = ()=>renderReportToPdf(true);
document.getElementById('modalClose').onclick = ()=>document.getElementById('modal').style.display='none';
</script>
</body>
</html>
